module.exports = class CaptchaGuard {

  constructor(req) {
    this.req = req;
    this.passTested = false;
    this.tested = false;
  }

  async passed() {
    if (this.tested) {
      return this.passTested;
    }
    this.tested = true;
    const captchaResponse = this.req.body.captchaResponse;
    if (!captchaResponse) {
      this.passTested = false;
    } else {
      this.passTested = await sails.helpers.verifyCaptcha(captchaResponse, this.req.ip);
      if (this.passTested) {
        this.resetAttempt();
      }
    }
    return this.passTested;
  }

  resetAttempt() {
    this.req.session.captchaAttemptThrottles = 0;
  }

  increaseAttempt() {
    this.req.session.captchaAttemptThrottles += 1;
  }

  shouldGuard() {
    const maxAttempt = sails.config.custom.login.maxLoginAttempt || 3;
    return this.req.session.captchaAttemptThrottles > maxAttempt;
  }

  dispose() {
    this.req.captchaGuard = null;
    this.req = null;
  }
};
